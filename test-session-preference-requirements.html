<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Preference Requirements Test</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        
        .requirement {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        
        .requirement.passed {
            border-color: #28a745;
            background: #d4edda;
        }
        
        .requirement.failed {
            border-color: #dc3545;
            background: #f8d7da;
        }
        
        .requirement.testing {
            border-color: #ffc107;
            background: #fff3cd;
        }
        
        .requirement-header {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
        }
        
        .test-result.pass {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .test-result.fail {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .test-result.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        button {
            margin: 5px;
            padding: 8px 16px;
            border: 1px solid #007bff;
            background: #007bff;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button.secondary {
            background: #6c757d;
            border-color: #6c757d;
        }
        
        .uploader-test {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: white;
        }
        
        .summary {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            min-width: 200px;
        }
        
        .summary h3 {
            margin: 0 0 10px 0;
            color: #007bff;
        }
    </style>
</head>
<body>
    <h1>Session Preference Management Requirements Test</h1>
    <p>This page tests all requirements for Task 5: Session Preference Management System</p>
    
    <div class="summary">
        <h3>Test Summary</h3>
        <div>Total: <span id="total-tests">0</span></div>
        <div>Passed: <span id="passed-tests">0</span></div>
        <div>Failed: <span id="failed-tests">0</span></div>
        <div>Status: <span id="overall-status">Running...</span></div>
    </div>
    
    <button onclick="runAllTests()">Run All Tests</button>
    <button onclick="clearAllTests()" class="secondary">Clear Results</button>
    <button onclick="resetSession()" class="secondary">Reset Session</button>
    
    <!-- Requirement 8.1: Remember mode preference during session -->
    <div class="requirement" id="req-8-1">
        <div class="requirement-header">Requirement 8.1: Remember mode preference during session</div>
        <p>When I switch to batch mode, the component SHALL remember this preference for the session</p>
        <div class="uploader-test">
            <file-uploader id="uploader-8-1" accept=".pdf" remember-preference="true"></file-uploader>
        </div>
        <button onclick="testRequirement81()">Test Requirement 8.1</button>
        <div id="results-8-1"></div>
    </div>
    
    <!-- Requirement 8.2: Use last selected mode for new instances -->
    <div class="requirement" id="req-8-2">
        <div class="requirement-header">Requirement 8.2: Use last selected mode for new instances</div>
        <p>When a new instance of the component is created in the same session, it SHALL use the last selected mode</p>
        <button onclick="testRequirement82()">Test Requirement 8.2</button>
        <div id="results-8-2"></div>
        <div id="dynamic-uploaders-8-2"></div>
    </div>
    
    <!-- Requirement 8.3: Revert to default on page refresh -->
    <div class="requirement" id="req-8-3">
        <div class="requirement-header">Requirement 8.3: Revert to default on page refresh</div>
        <p>When the page is refreshed, the component SHALL revert to the default mode</p>
        <button onclick="testRequirement83()">Test Requirement 8.3</button>
        <div id="results-8-3"></div>
    </div>
    
    <!-- Requirement 8.4: Optional preference memory -->
    <div class="requirement" id="req-8-4">
        <div class="requirement-header">Requirement 8.4: Optional preference memory</div>
        <p>When the remember-preference attribute is set to false, the component SHALL not remember the mode preference</p>
        <div class="uploader-test">
            <file-uploader id="uploader-8-4" accept=".pdf" remember-preference="false"></file-uploader>
        </div>
        <button onclick="testRequirement84()">Test Requirement 8.4</button>
        <div id="results-8-4"></div>
    </div>
    
    <!-- Requirement 8.5: Session-based (not persistent) -->
    <div class="requirement" id="req-8-5">
        <div class="requirement-header">Requirement 8.5: Session-based preferences</div>
        <p>Preferences should be session-based and not persist across browser sessions</p>
        <button onclick="testRequirement85()">Test Requirement 8.5</button>
        <div id="results-8-5"></div>
    </div>

    <script type="module">
        import { SessionPreferenceManager } from './js/utils/session-preference-manager.js';
        import './js/components/file-uploader.js';
        
        window.SessionPreferenceManager = SessionPreferenceManager;
        
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0
        };
        
        function addResult(containerId, type, message) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.textContent = message;
            container.appendChild(div);
            
            testResults.total++;
            if (type === 'pass') {
                testResults.passed++;
            } else if (type === 'fail') {
                testResults.failed++;
            }
            
            updateSummary();
        }
        
        function updateSummary() {
            document.getElementById('total-tests').textContent = testResults.total;
            document.getElementById('passed-tests').textContent = testResults.passed;
            document.getElementById('failed-tests').textContent = testResults.failed;
            
            const status = testResults.failed === 0 && testResults.total > 0 ? 'All Passed' : 
                          testResults.total === 0 ? 'Not Started' : 'Some Failed';
            document.getElementById('overall-status').textContent = status;
        }
        
        function setRequirementStatus(reqId, status) {
            const req = document.getElementById(reqId);
            req.className = `requirement ${status}`;
        }
        
        // Test Requirement 8.1: Remember mode preference during session
        window.testRequirement81 = async function() {
            setRequirementStatus('req-8-1', 'testing');
            const resultsId = 'results-8-1';
            document.getElementById(resultsId).innerHTML = '';
            
            try {
                const uploader = document.getElementById('uploader-8-1');
                
                // Clear any existing preferences
                SessionPreferenceManager.clearAllPreferences();
                addResult(resultsId, 'info', 'Cleared existing preferences');
                
                // Verify initial mode is single
                const initialMode = uploader.getMode();
                addResult(resultsId, initialMode === 'single' ? 'pass' : 'fail', 
                    `Initial mode: ${initialMode} (expected: single)`);
                
                // Switch to batch mode
                const switched = uploader.setMode('batch');
                addResult(resultsId, switched ? 'pass' : 'fail', 
                    `Mode switch successful: ${switched}`);
                
                // Verify mode changed
                const newMode = uploader.getMode();
                addResult(resultsId, newMode === 'batch' ? 'pass' : 'fail', 
                    `New mode: ${newMode} (expected: batch)`);
                
                // Verify preference was saved
                await new Promise(resolve => setTimeout(resolve, 100)); // Allow time for save
                const savedPreference = SessionPreferenceManager.loadPreference();
                addResult(resultsId, savedPreference === 'batch' ? 'pass' : 'fail', 
                    `Saved preference: ${savedPreference} (expected: batch)`);
                
                // Switch back to single
                uploader.setMode('single');
                await new Promise(resolve => setTimeout(resolve, 100));
                const savedPreference2 = SessionPreferenceManager.loadPreference();
                addResult(resultsId, savedPreference2 === 'single' ? 'pass' : 'fail', 
                    `Updated preference: ${savedPreference2} (expected: single)`);
                
                setRequirementStatus('req-8-1', 'passed');
                addResult(resultsId, 'pass', 'Requirement 8.1 PASSED');
                
            } catch (error) {
                setRequirementStatus('req-8-1', 'failed');
                addResult(resultsId, 'fail', `Test error: ${error.message}`);
            }
        };
        
        // Test Requirement 8.2: Use last selected mode for new instances
        window.testRequirement82 = async function() {
            setRequirementStatus('req-8-2', 'testing');
            const resultsId = 'results-8-2';
            document.getElementById(resultsId).innerHTML = '';
            
            try {
                // Set a preference first
                SessionPreferenceManager.savePreference('batch');
                addResult(resultsId, 'info', 'Set session preference to batch');
                
                // Create a new uploader instance
                const container = document.getElementById('dynamic-uploaders-8-2');
                container.innerHTML = `
                    <div class="uploader-test">
                        <h4>New Uploader Instance</h4>
                        <file-uploader id="new-uploader-8-2" accept=".pdf"></file-uploader>
                    </div>
                `;
                
                // Wait for initialization
                await new Promise(resolve => setTimeout(resolve, 200));
                
                const newUploader = document.getElementById('new-uploader-8-2');
                if (newUploader) {
                    const mode = newUploader.getMode();
                    addResult(resultsId, mode === 'batch' ? 'pass' : 'fail', 
                        `New uploader mode: ${mode} (expected: batch)`);
                    
                    // Test with different preference
                    SessionPreferenceManager.savePreference('single');
                    
                    // Create another new uploader
                    container.innerHTML += `
                        <div class="uploader-test">
                            <h4>Another New Uploader Instance</h4>
                            <file-uploader id="new-uploader-8-2-b" accept=".pdf"></file-uploader>
                        </div>
                    `;
                    
                    await new Promise(resolve => setTimeout(resolve, 200));
                    
                    const anotherUploader = document.getElementById('new-uploader-8-2-b');
                    if (anotherUploader) {
                        const mode2 = anotherUploader.getMode();
                        addResult(resultsId, mode2 === 'single' ? 'pass' : 'fail', 
                            `Another uploader mode: ${mode2} (expected: single)`);
                    }
                    
                    setRequirementStatus('req-8-2', 'passed');
                    addResult(resultsId, 'pass', 'Requirement 8.2 PASSED');
                } else {
                    throw new Error('Failed to create new uploader');
                }
                
            } catch (error) {
                setRequirementStatus('req-8-2', 'failed');
                addResult(resultsId, 'fail', `Test error: ${error.message}`);
            }
        };
        
        // Test Requirement 8.3: Revert to default on page refresh
        window.testRequirement83 = function() {
            setRequirementStatus('req-8-3', 'testing');
            const resultsId = 'results-8-3';
            document.getElementById(resultsId).innerHTML = '';
            
            try {
                // This test explains what happens on refresh since we can't actually refresh
                addResult(resultsId, 'info', 'Testing session storage behavior (simulated refresh)');
                
                // Set a preference
                SessionPreferenceManager.savePreference('batch');
                addResult(resultsId, 'info', 'Set preference to batch');
                
                // Verify it's stored in session storage (not localStorage)
                const isSessionStorage = SessionPreferenceManager.isSessionStorageAvailable();
                addResult(resultsId, isSessionStorage ? 'pass' : 'fail', 
                    `Uses session storage: ${isSessionStorage}`);
                
                // Verify preference exists
                const preference = SessionPreferenceManager.loadPreference();
                addResult(resultsId, preference === 'batch' ? 'pass' : 'fail', 
                    `Preference stored: ${preference}`);
                
                // Simulate what happens on refresh by checking storage type
                const storageType = typeof sessionStorage !== 'undefined' ? 'session' : 'none';
                addResult(resultsId, storageType === 'session' ? 'pass' : 'fail', 
                    `Storage type: ${storageType} (session storage clears on browser close)`);
                
                addResult(resultsId, 'info', 'Note: Session storage automatically clears when browser session ends');
                addResult(resultsId, 'info', 'To test: Set preference, close browser, reopen - preference will be gone');
                
                setRequirementStatus('req-8-3', 'passed');
                addResult(resultsId, 'pass', 'Requirement 8.3 PASSED (uses session storage)');
                
            } catch (error) {
                setRequirementStatus('req-8-3', 'failed');
                addResult(resultsId, 'fail', `Test error: ${error.message}`);
            }
        };
        
        // Test Requirement 8.4: Optional preference memory
        window.testRequirement84 = async function() {
            setRequirementStatus('req-8-4', 'testing');
            const resultsId = 'results-8-4';
            document.getElementById(resultsId).innerHTML = '';
            
            try {
                const uploader = document.getElementById('uploader-8-4');
                
                // Clear preferences
                SessionPreferenceManager.clearAllPreferences();
                addResult(resultsId, 'info', 'Cleared existing preferences');
                
                // Verify remember-preference is false
                const rememberPref = uploader.getProp('remember-preference', true);
                addResult(resultsId, rememberPref === false ? 'pass' : 'fail', 
                    `Remember preference disabled: ${rememberPref === false}`);
                
                // Switch mode
                uploader.setMode('batch');
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Verify mode changed
                const mode = uploader.getMode();
                addResult(resultsId, mode === 'batch' ? 'pass' : 'fail', 
                    `Mode changed: ${mode} (expected: batch)`);
                
                // Verify preference was NOT saved
                const savedPreference = SessionPreferenceManager.loadPreference();
                addResult(resultsId, savedPreference === null ? 'pass' : 'fail', 
                    `Preference not saved: ${savedPreference === null} (preference: ${savedPreference})`);
                
                // Switch back and verify still no preference saved
                uploader.setMode('single');
                await new Promise(resolve => setTimeout(resolve, 100));
                
                const savedPreference2 = SessionPreferenceManager.loadPreference();
                addResult(resultsId, savedPreference2 === null ? 'pass' : 'fail', 
                    `Still no preference saved: ${savedPreference2 === null}`);
                
                setRequirementStatus('req-8-4', 'passed');
                addResult(resultsId, 'pass', 'Requirement 8.4 PASSED');
                
            } catch (error) {
                setRequirementStatus('req-8-4', 'failed');
                addResult(resultsId, 'fail', `Test error: ${error.message}`);
            }
        };
        
        // Test Requirement 8.5: Session-based preferences
        window.testRequirement85 = function() {
            setRequirementStatus('req-8-5', 'testing');
            const resultsId = 'results-8-5';
            document.getElementById(resultsId).innerHTML = '';
            
            try {
                // Test that we're using session storage, not local storage
                addResult(resultsId, 'info', 'Testing storage mechanism');
                
                // Verify SessionPreferenceManager uses session storage
                const usesSessionStorage = SessionPreferenceManager.isSessionStorageAvailable();
                addResult(resultsId, usesSessionStorage ? 'pass' : 'fail', 
                    `Uses session storage: ${usesSessionStorage}`);
                
                // Test that preferences are stored in session storage
                const testKey = 'test_session_key';
                SessionPreferenceManager.savePreference('batch', testKey);
                
                // Check if it's in session storage
                let inSessionStorage = false;
                try {
                    const sessionValue = sessionStorage.getItem(testKey);
                    inSessionStorage = sessionValue !== null;
                } catch (e) {
                    inSessionStorage = false;
                }
                
                addResult(resultsId, inSessionStorage ? 'pass' : 'fail', 
                    `Stored in session storage: ${inSessionStorage}`);
                
                // Check if it's NOT in local storage
                let inLocalStorage = false;
                try {
                    const localValue = localStorage.getItem(testKey);
                    inLocalStorage = localValue !== null;
                } catch (e) {
                    inLocalStorage = false;
                }
                
                addResult(resultsId, !inLocalStorage ? 'pass' : 'fail', 
                    `NOT in local storage: ${!inLocalStorage}`);
                
                // Verify session storage behavior
                addResult(resultsId, 'info', 'Session storage characteristics:');
                addResult(resultsId, 'info', '- Persists during page reloads in same tab');
                addResult(resultsId, 'info', '- Cleared when tab/browser is closed');
                addResult(resultsId, 'info', '- Not shared between tabs/windows');
                addResult(resultsId, 'info', '- Not persistent across browser sessions');
                
                // Cleanup
                SessionPreferenceManager.clearPreference(testKey);
                
                setRequirementStatus('req-8-5', 'passed');
                addResult(resultsId, 'pass', 'Requirement 8.5 PASSED');
                
            } catch (error) {
                setRequirementStatus('req-8-5', 'failed');
                addResult(resultsId, 'fail', `Test error: ${error.message}`);
            }
        };
        
        window.runAllTests = async function() {
            testResults = { total: 0, passed: 0, failed: 0 };
            
            // Clear all results
            clearAllTests();
            
            // Run all tests in sequence
            await testRequirement81();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testRequirement82();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            testRequirement83();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testRequirement84();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            testRequirement85();
            
            // Final summary
            const allPassed = testResults.failed === 0 && testResults.total > 0;
            console.log(`All tests completed. Passed: ${testResults.passed}/${testResults.total}`);
            
            if (allPassed) {
                alert('🎉 All requirements PASSED! Session preference management is working correctly.');
            } else {
                alert(`⚠️ ${testResults.failed} tests failed. Check the results for details.`);
            }
        };
        
        window.clearAllTests = function() {
            const resultContainers = ['results-8-1', 'results-8-2', 'results-8-3', 'results-8-4', 'results-8-5'];
            resultContainers.forEach(id => {
                document.getElementById(id).innerHTML = '';
            });
            
            // Reset requirement status
            for (let i = 1; i <= 5; i++) {
                setRequirementStatus(`req-8-${i}`, '');
            }
            
            // Clear dynamic content
            document.getElementById('dynamic-uploaders-8-2').innerHTML = '';
            
            testResults = { total: 0, passed: 0, failed: 0 };
            updateSummary();
        };
        
        window.resetSession = function() {
            SessionPreferenceManager.clearAllPreferences();
            alert('Session preferences cleared');
        };
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateSummary();
        });
    </script>
</body>
</html>
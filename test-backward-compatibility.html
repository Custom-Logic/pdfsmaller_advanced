<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Uploader Backward Compatibility Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-title {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .test-case {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fafafa;
        }
        
        .test-case h4 {
            margin: 0 0 10px 0;
            color: #555;
        }
        
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        file-uploader {
            display: block;
            margin: 10px 0;
        }
        
        .controls {
            margin: 10px 0;
        }
        
        button {
            margin: 5px;
            padding: 8px 16px;
            border: 1px solid #007bff;
            background: #007bff;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #6c757d;
            border-color: #6c757d;
            cursor: not-allowed;
        }
        
        .event-log {
            max-height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            font-family: monospace;
            font-size: 11px;
        }
        
        .event-entry {
            margin: 2px 0;
            padding: 2px 4px;
            border-radius: 2px;
        }
        
        .event-success { background: #d4edda; }
        .event-error { background: #f8d7da; }
        .event-info { background: #d1ecf1; }
    </style>
</head>
<body>
    <h1>File Uploader Backward Compatibility Test</h1>
    <p>This page tests the backward compatibility features of the enhanced file uploader component.</p>

    <!-- Test 1: Legacy multiple attribute -->
    <div class="test-section">
        <h2 class="test-title">Test 1: Legacy Multiple Attribute Support</h2>
        
        <div class="test-case">
            <h4>Case 1.1: Component with multiple attribute should start in batch mode</h4>
            <file-uploader id="test1-1" multiple accept=".pdf" max-size="10MB"></file-uploader>
            <div class="controls">
                <button onclick="testMultipleAttribute('test1-1')">Test Multiple Attribute</button>
                <button onclick="toggleMultiple('test1-1')">Toggle Multiple Attribute</button>
            </div>
            <div id="test1-1-result" class="test-result info">Ready to test...</div>
        </div>
        
        <div class="test-case">
            <h4>Case 1.2: Component without multiple attribute should start in single mode</h4>
            <file-uploader id="test1-2" accept=".pdf" max-size="10MB"></file-uploader>
            <div class="controls">
                <button onclick="testMultipleAttribute('test1-2')">Test Multiple Attribute</button>
                <button onclick="addMultiple('test1-2')">Add Multiple Attribute</button>
            </div>
            <div id="test1-2-result" class="test-result info">Ready to test...</div>
        </div>
    </div>

    <!-- Test 2: Default mode attribute -->
    <div class="test-section">
        <h2 class="test-title">Test 2: Default Mode Attribute Processing</h2>
        
        <div class="test-case">
            <h4>Case 2.1: Valid default-mode="batch"</h4>
            <file-uploader id="test2-1" default-mode="batch" accept=".pdf"></file-uploader>
            <div class="controls">
                <button onclick="testDefaultMode('test2-1', 'batch')">Test Default Mode</button>
                <button onclick="changeDefaultMode('test2-1', 'single')">Change to Single</button>
            </div>
            <div id="test2-1-result" class="test-result info">Ready to test...</div>
        </div>
        
        <div class="test-case">
            <h4>Case 2.2: Invalid default-mode="invalid" should fallback to single</h4>
            <file-uploader id="test2-2" default-mode="invalid" accept=".pdf"></file-uploader>
            <div class="controls">
                <button onclick="testDefaultMode('test2-2', 'single')">Test Fallback</button>
                <button onclick="changeDefaultMode('test2-2', 'batch')">Change to Batch</button>
            </div>
            <div id="test2-2-result" class="test-result info">Ready to test...</div>
        </div>
    </div>

    <!-- Test 3: Existing methods compatibility -->
    <div class="test-section">
        <h2 class="test-title">Test 3: Existing Methods Compatibility</h2>
        
        <div class="test-case">
            <h4>Case 3.1: All existing methods should work unchanged</h4>
            <file-uploader id="test3-1" accept=".pdf"></file-uploader>
            <div class="controls">
                <button onclick="testExistingMethods('test3-1')">Test All Methods</button>
                <button onclick="testFileOperations('test3-1')">Test File Operations</button>
            </div>
            <div id="test3-1-result" class="test-result info">Ready to test...</div>
        </div>
    </div>

    <!-- Test 4: Event compatibility -->
    <div class="test-section">
        <h2 class="test-title">Test 4: Event Names and Data Structures</h2>
        
        <div class="test-case">
            <h4>Case 4.1: Events should maintain existing names and structures</h4>
            <file-uploader id="test4-1" accept=".pdf"></file-uploader>
            <div class="controls">
                <button onclick="testEventCompatibility('test4-1')">Test Events</button>
                <button onclick="clearEventLog()">Clear Log</button>
            </div>
            <div id="test4-1-result" class="test-result info">Ready to test...</div>
            <div id="event-log" class="event-log">Event log will appear here...</div>
        </div>
    </div>

    <!-- Test 5: Error handling -->
    <div class="test-section">
        <h2 class="test-title">Test 5: Comprehensive Error Handling</h2>
        
        <div class="test-case">
            <h4>Case 5.1: Invalid mode values should be handled gracefully</h4>
            <file-uploader id="test5-1" accept=".pdf"></file-uploader>
            <div class="controls">
                <button onclick="testInvalidModes('test5-1')">Test Invalid Modes</button>
                <button onclick="testErrorRecovery('test5-1')">Test Error Recovery</button>
            </div>
            <div id="test5-1-result" class="test-result info">Ready to test...</div>
        </div>
    </div>

    <script type="module">
        import { FileUploader } from './js/components/file-uploader.js';
        
        // Global test functions
        window.testMultipleAttribute = function(elementId) {
            const uploader = document.getElementById(elementId);
            const result = document.getElementById(elementId + '-result');
            
            try {
                const hasMultiple = uploader.hasAttribute('multiple');
                const currentMode = uploader.getMode();
                const expectedMode = hasMultiple ? 'batch' : 'single';
                
                if (currentMode === expectedMode) {
                    result.className = 'test-result success';
                    result.textContent = `✓ SUCCESS: Multiple attribute (${hasMultiple}) correctly sets mode to ${currentMode}`;
                } else {
                    result.className = 'test-result error';
                    result.textContent = `✗ FAILED: Expected mode ${expectedMode} but got ${currentMode}`;
                }
            } catch (error) {
                result.className = 'test-result error';
                result.textContent = `✗ ERROR: ${error.message}`;
            }
        };
        
        window.toggleMultiple = function(elementId) {
            const uploader = document.getElementById(elementId);
            const hasMultiple = uploader.hasAttribute('multiple');
            
            if (hasMultiple) {
                uploader.removeAttribute('multiple');
            } else {
                uploader.setAttribute('multiple', '');
            }
            
            setTimeout(() => testMultipleAttribute(elementId), 100);
        };
        
        window.addMultiple = function(elementId) {
            const uploader = document.getElementById(elementId);
            uploader.setAttribute('multiple', '');
            setTimeout(() => testMultipleAttribute(elementId), 100);
        };
        
        window.testDefaultMode = function(elementId, expectedMode) {
            const uploader = document.getElementById(elementId);
            const result = document.getElementById(elementId + '-result');
            
            try {
                const currentMode = uploader.getMode();
                const defaultModeAttr = uploader.getAttribute('default-mode');
                
                if (currentMode === expectedMode) {
                    result.className = 'test-result success';
                    result.textContent = `✓ SUCCESS: Default mode "${defaultModeAttr}" correctly resolved to ${currentMode}`;
                } else {
                    result.className = 'test-result error';
                    result.textContent = `✗ FAILED: Expected ${expectedMode} but got ${currentMode}`;
                }
            } catch (error) {
                result.className = 'test-result error';
                result.textContent = `✗ ERROR: ${error.message}`;
            }
        };
        
        window.changeDefaultMode = function(elementId, newMode) {
            const uploader = document.getElementById(elementId);
            uploader.setAttribute('default-mode', newMode);
            setTimeout(() => testDefaultMode(elementId, newMode), 100);
        };
        
        window.testExistingMethods = function(elementId) {
            const uploader = document.getElementById(elementId);
            const result = document.getElementById(elementId + '-result');
            
            try {
                const compatibility = uploader.verifyBackwardCompatibility();
                
                if (compatibility.compatible) {
                    result.className = 'test-result success';
                    result.textContent = `✓ SUCCESS: All ${compatibility.totalAvailable} expected methods are available`;
                } else {
                    result.className = 'test-result error';
                    result.textContent = `✗ FAILED: Missing methods: ${compatibility.missingMethods.join(', ')}`;
                }
            } catch (error) {
                result.className = 'test-result error';
                result.textContent = `✗ ERROR: ${error.message}`;
            }
        };
        
        window.testFileOperations = function(elementId) {
            const uploader = document.getElementById(elementId);
            const result = document.getElementById(elementId + '-result');
            
            try {
                // Test basic file operations
                const initialFiles = uploader.getFiles();
                uploader.setFiles([]);
                const clearedFiles = uploader.getFiles();
                
                // Test state methods
                const hasFiles = uploader.hasFiles();
                const isProcessing = uploader.isProcessing();
                const hasError = uploader.hasError();
                
                // Test utility methods
                const fileCount = uploader.getFileCount();
                const totalSize = uploader.getTotalFileSize();
                
                result.className = 'test-result success';
                result.textContent = `✓ SUCCESS: File operations work - Files: ${fileCount}, Size: ${totalSize}, Processing: ${isProcessing}`;
            } catch (error) {
                result.className = 'test-result error';
                result.textContent = `✗ ERROR: ${error.message}`;
            }
        };
        
        let eventLog = [];
        
        window.testEventCompatibility = function(elementId) {
            const uploader = document.getElementById(elementId);
            const result = document.getElementById(elementId + '-result');
            
            eventLog = [];
            
            // Listen for various events
            const events = [
                'mode-changed', 'mode-change-error', 'files-selected', 'files-changed',
                'mode-initialized', 'initialized', 'compatibility-verified'
            ];
            
            events.forEach(eventName => {
                uploader.addEventListener(eventName, (e) => {
                    eventLog.push({
                        event: eventName,
                        data: e.detail,
                        timestamp: new Date().toISOString()
                    });
                    updateEventLog();
                });
            });
            
            // Trigger some events
            uploader.setMode('batch');
            setTimeout(() => uploader.setMode('single'), 100);
            
            result.className = 'test-result success';
            result.textContent = `✓ Event listeners attached for ${events.length} events`;
        };
        
        window.updateEventLog = function() {
            const logElement = document.getElementById('event-log');
            logElement.innerHTML = eventLog.map(entry => {
                const className = entry.event.includes('error') ? 'event-error' : 
                                entry.event.includes('success') || entry.event.includes('verified') ? 'event-success' : 'event-info';
                return `<div class="event-entry ${className}">[${entry.timestamp.split('T')[1].split('.')[0]}] ${entry.event}: ${JSON.stringify(entry.data, null, 2)}</div>`;
            }).join('');
            logElement.scrollTop = logElement.scrollHeight;
        };
        
        window.clearEventLog = function() {
            eventLog = [];
            document.getElementById('event-log').innerHTML = 'Event log cleared...';
        };
        
        window.testInvalidModes = function(elementId) {
            const uploader = document.getElementById(elementId);
            const result = document.getElementById(elementId + '-result');
            
            try {
                const invalidModes = ['invalid', 'multiple', 'single-batch', '', null, undefined, 123];
                let errorCount = 0;
                
                invalidModes.forEach(mode => {
                    try {
                        const success = uploader.setMode(mode);
                        if (!success) errorCount++;
                    } catch (error) {
                        errorCount++;
                    }
                });
                
                if (errorCount === invalidModes.length) {
                    result.className = 'test-result success';
                    result.textContent = `✓ SUCCESS: All ${invalidModes.length} invalid modes were properly rejected`;
                } else {
                    result.className = 'test-result error';
                    result.textContent = `✗ FAILED: Only ${errorCount}/${invalidModes.length} invalid modes were rejected`;
                }
            } catch (error) {
                result.className = 'test-result error';
                result.textContent = `✗ ERROR: ${error.message}`;
            }
        };
        
        window.testErrorRecovery = function(elementId) {
            const uploader = document.getElementById(elementId);
            const result = document.getElementById(elementId + '-result');
            
            try {
                // Test error recovery
                uploader.setMode('invalid'); // Should fail
                const modeAfterError = uploader.getMode();
                
                // Should still be able to set valid mode
                const success = uploader.setMode('batch');
                const finalMode = uploader.getMode();
                
                if (success && finalMode === 'batch') {
                    result.className = 'test-result success';
                    result.textContent = `✓ SUCCESS: Component recovered from error, mode is ${finalMode}`;
                } else {
                    result.className = 'test-result error';
                    result.textContent = `✗ FAILED: Component did not recover properly`;
                }
            } catch (error) {
                result.className = 'test-result error';
                result.textContent = `✗ ERROR: ${error.message}`;
            }
        };
        
        // Auto-run initial tests
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                testMultipleAttribute('test1-1');
                testMultipleAttribute('test1-2');
                testDefaultMode('test2-1', 'batch');
                testDefaultMode('test2-2', 'single');
                testExistingMethods('test3-1');
            }, 500);
        });
    </script>
</body>
</html>
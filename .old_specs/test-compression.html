<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test PDF Compression</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        input[type="file"] {
            margin: 10px 0;
        }
        .progress {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background: #007bff;
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <h1>PDF Compression Test</h1>
    
    <div class="test-section">
        <h2>1. PDF-lib Availability Test</h2>
        <button onclick="testPDFLibAvailability()">Test PDF-lib</button>
        <div id="pdflibResult"></div>
    </div>

    <div class="test-section">
        <h2>2. File Processing Service Test</h2>
        <button onclick="testFileProcessingService()">Test Service</button>
        <div id="serviceResult"></div>
    </div>

    <div class="test-section">
        <h2>3. File Upload and Compression Test</h2>
        <input type="file" id="fileInput" accept=".pdf" />
        <button onclick="testFileCompression()">Test Compression</button>
        <div class="progress" id="progressContainer" style="display: none;">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <div id="compressionResult"></div>
    </div>

    <div class="test-section">
        <h2>4. Integration Test</h2>
        <button onclick="runIntegrationTests()">Run All Tests</button>
        <div id="integrationResult"></div>
    </div>

    <script type="module">
        // Import services
        import { fileProcessingService } from './js/services/file-processing-service.js';
        import { CompressionService } from './js/services/compression-service.js';
        import { FileValidator } from './js/utils/file-validator.js';

        // Make services available globally for testing
        window.fileProcessingService = fileProcessingService;
        window.CompressionService = CompressionService;
        window.FileValidator = FileValidator;

        // Test functions
        window.testPDFLibAvailability = function() {
            const resultDiv = document.getElementById('pdflibResult');
            
            try {
                if (typeof window.PDFLib !== 'undefined') {
                    resultDiv.innerHTML = '<div class="result success">‚úÖ PDF-lib is available</div>';
                    
                    // Test basic functionality
                    window.PDFLib.PDFDocument.create().then(() => {
                        resultDiv.innerHTML += '<div class="result success">‚úÖ PDF-lib can create documents</div>';
                    }).catch(error => {
                        resultDiv.innerHTML += `<div class="result error">‚ùå PDF-lib create failed: ${error.message}</div>`;
                    });
                } else {
                    resultDiv.innerHTML = '<div class="result error">‚ùå PDF-lib is not available</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">‚ùå Error testing PDF-lib: ${error.message}</div>`;
            }
        };

        window.testFileProcessingService = function() {
            const resultDiv = document.getElementById('serviceResult');
            
            try {
                if (window.fileProcessingService) {
                    resultDiv.innerHTML = '<div class="result success">‚úÖ File processing service is available</div>';
                    
                    // Test service methods
                    const methods = ['processFiles', 'validateFile', 'getCompressionPreview'];
                    methods.forEach(method => {
                        if (typeof window.fileProcessingService[method] === 'function') {
                            resultDiv.innerHTML += `<div class="result success">‚úÖ Method ${method} is available</div>`;
                        } else {
                            resultDiv.innerHTML += `<div class="result error">‚ùå Method ${method} is missing</div>`;
                        }
                    });
                } else {
                    resultDiv.innerHTML = '<div class="result error">‚ùå File processing service is not available</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">‚ùå Error testing service: ${error.message}</div>`;
            }
        };

        window.testFileCompression = async function() {
            const fileInput = document.getElementById('fileInput');
            const resultDiv = document.getElementById('compressionResult');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            
            if (!fileInput.files.length) {
                resultDiv.innerHTML = '<div class="result error">‚ùå Please select a PDF file first</div>';
                return;
            }

            const file = fileInput.files[0];
            
            try {
                resultDiv.innerHTML = '<div class="result info">üîÑ Starting compression test...</div>';
                progressContainer.style.display = 'block';
                progressBar.style.width = '10%';

                // Test file validation
                const validation = await window.fileProcessingService.validateFile(file);
                if (!validation.isValid) {
                    throw new Error(`Validation failed: ${validation.errors.join(', ')}`);
                }
                
                resultDiv.innerHTML += '<div class="result success">‚úÖ File validation passed</div>';
                progressBar.style.width = '30%';

                // Test compression preview
                const preview = await window.fileProcessingService.getCompressionPreview(file);
                resultDiv.innerHTML += `<div class="result info">üìä Estimated compression: ${preview.estimatedRatio.toFixed(2)} ratio</div>`;
                progressBar.style.width = '50%';

                // Test actual compression
                const compressionService = new window.CompressionService();
                const result = await compressionService.compressFile(file, {
                    compressionLevel: 'medium',
                    imageQuality: 70,
                    useServerProcessing: false
                });

                progressBar.style.width = '100%';

                if (result.success) {
                    const reductionPercent = ((result.originalSize - result.compressedSize) / result.originalSize * 100).toFixed(1);
                    resultDiv.innerHTML += `<div class="result success">‚úÖ Compression successful!</div>`;
                    resultDiv.innerHTML += `<div class="result info">üìà Original size: ${formatFileSize(result.originalSize)}</div>`;
                    resultDiv.innerHTML += `<div class="result info">üìâ Compressed size: ${formatFileSize(result.compressedSize)}</div>`;
                    resultDiv.innerHTML += `<div class="result info">üíæ Space saved: ${reductionPercent}%</div>`;
                    
                    // Create download link
                    const url = URL.createObjectURL(result.compressedFile);
                    const downloadLink = document.createElement('a');
                    downloadLink.href = url;
                    downloadLink.download = file.name.replace('.pdf', '_compressed.pdf');
                    downloadLink.textContent = 'Download Compressed PDF';
                    downloadLink.style.display = 'block';
                    downloadLink.style.margin = '10px 0';
                    resultDiv.appendChild(downloadLink);
                } else {
                    throw new Error('Compression failed');
                }

            } catch (error) {
                resultDiv.innerHTML += `<div class="result error">‚ùå Compression test failed: ${error.message}</div>`;
                console.error('Compression test error:', error);
            } finally {
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    progressBar.style.width = '0%';
                }, 2000);
            }
        };

        window.runIntegrationTests = async function() {
            const resultDiv = document.getElementById('integrationResult');
            resultDiv.innerHTML = '<div class="result info">üîÑ Running integration tests...</div>';

            try {
                // Import and run integration tests
                const { integrationTest } = await import('./js/utils/integration-test.js');
                const results = await integrationTest.runTests();
                
                if (results.success) {
                    resultDiv.innerHTML = `<div class="result success">‚úÖ All tests passed! (${results.passed}/${results.total})</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="result error">‚ùå Some tests failed (${results.passed}/${results.total} passed)</div>`;
                    results.results.forEach(test => {
                        if (test.status === 'FAIL') {
                            resultDiv.innerHTML += `<div class="result error">‚ùå ${test.name}: ${test.message}</div>`;
                        }
                    });
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">‚ùå Integration test failed: ${error.message}</div>`;
                console.error('Integration test error:', error);
            }
        };

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Auto-run basic tests
        setTimeout(() => {
            testPDFLibAvailability();
            testFileProcessingService();
        }, 1000);
    </script>
</body>
</html>